<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cell Collective: The Modeling Mystery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Exo 2', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a4f6e 0%, #1a1a2e 100%);
            color: #ffffff;
            overflow: hidden;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        #game-header {
            background: rgba(10, 79, 110, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #00d4ff;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        #game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 900;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5), 0 0 20px rgba(0, 212, 255, 0.3);
            letter-spacing: 1.5px;
        }

        #progress-tracker {
            display: flex;
            gap: 10px;
        }

        .fundamental-badge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .fundamental-badge.completed {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.6);
        }

        /* Main Area */
        #game-main {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        /* Story Panel */
        #story-panel {
            max-width: 900px;
            width: 100%;
        }

        .scene-container {
            animation: fadeIn 0.6s ease;
        }

        .scene-image {
            width: 100%;
            height: 400px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.4);
            border: 3px solid #00d4ff;
        }

        .dialogue-container {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15) 0%, rgba(0, 153, 204, 0.15) 100%);
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #00d4ff;
        }

        .speaker-name {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 22px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            letter-spacing: 0.5px;
        }

        .dialogue-text {
            font-family: 'Exo 2', sans-serif;
            line-height: 1.9;
            color: #e0e0e0;
            font-size: 19px;
            font-weight: 400;
        }

        .continue-hint {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            margin-top: 30px;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
            padding: 15px 40px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
            border: 2px solid #00d4ff;
            display: inline-block;
            animation: pulse 2s infinite;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .continue-hint:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.8);
            background: linear-gradient(135deg, #00ffff 0%, #00d4ff 100%);
        }

        .continue-hint:active {
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Header -->
        <div id="game-header">
            <div id="game-title">Cell Collective: The Modeling Mystery</div>
            <div id="progress-tracker">
                <div class="fundamental-badge" title="Identify Components">1</div>
                <div class="fundamental-badge" title="Define Relationships">2</div>
                <div class="fundamental-badge" title="Set Initial Conditions">3</div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div id="game-main">
            <div id="story-panel">
                <div class="scene-container">
                    <div class="scene-image" id="scene-img"></div>
                    <div class="dialogue-container">
                        <div class="speaker-name">Dr. Elena Rodriguez</div>
                        <div class="dialogue-text" id="dialogue-text">
                            Hey there! I'm Dr. Elena, and I need YOUR help! Something weird is happening in my lab...
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <div class="continue-hint" onclick="nextDialogue()">
                            Continue Adventure ‚Üí
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Nano Banana API Configuration
        const API_KEY = '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';
        const API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const IMAGE_MODEL = 'google/gemini-2.5-flash-image';

        // SVG placeholder images
        const svgImages = {
            drElena: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><defs><linearGradient id="bg1" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%230a4f6e;stop-opacity:1" /><stop offset="100%" style="stop-color:%231a1a2e;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23bg1)" width="800" height="600"/><circle cx="400" cy="240" r="100" fill="%23d4a574"/><ellipse cx="400" cy="400" rx="140" ry="180" fill="%23ffffff"/><rect x="260" y="380" width="280" height="220" fill="%23ffffff" rx="10"/><circle cx="370" cy="220" r="12" fill="%23000"/><circle cx="430" cy="220" r="12" fill="%23000"/><path d="M 360 260 Q 400 275 440 260" stroke="%23000" stroke-width="2" fill="none"/><ellipse cx="400" cy="180" rx="110" ry="80" fill="%23000"/><text x="400" y="560" font-family="Arial" font-size="28" fill="%2300d4ff" text-anchor="middle" font-weight="bold">Dr. Elena</text></svg>',
            lab: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><defs><linearGradient id="bg2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%230a4f6e;stop-opacity:1" /><stop offset="100%" style="stop-color:%231a1a2e;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23bg2)" width="800" height="600"/><rect x="100" y="180" width="600" height="320" fill="%23193a52" rx="15"/><text x="400" y="350" font-family="Arial" font-size="60" fill="%2300d4ff" text-anchor="middle">‚öóÔ∏è</text><text x="400" y="560" font-family="Arial" font-size="28" fill="%2300d4ff" text-anchor="middle" font-weight="bold">Mystery Lab</text></svg>'
        };

        // Image prompts for AI generation
        const imagePrompts = {
            drElena: "Professional portrait of a friendly Hispanic female scientist Dr. Elena Rodriguez in her 30s, wearing a white lab coat with blue accents, warm smile, standing in a modern molecular biology laboratory with blue and cyan lighting, Cell Collective branding colors, photorealistic, professional photography, bright and welcoming",
            lab: "Wide shot of a modern molecular biology research laboratory, computer screens showing blue and cyan data patterns, scientific equipment, petri dishes, microscopes, dramatic blue lighting suggesting mystery, photorealistic, cinematic composition, Cell Collective aesthetic"
        };

        // Dialogue data
        const dialogues = [
            {
                text: "Hey there! I'm Dr. Elena, and I need YOUR help! Something weird is happening in my lab...",
                imageName: 'drElena'
            },
            {
                text: "My cells are acting super strange! We need to build a model to figure out what's going on!",
                imageName: 'lab'
            },
            {
                text: "Ready to be a scientist and solve this mystery with me? Let's do this!",
                imageName: 'drElena'
            }
        ];

        let currentDialogue = 0;
        let generatedImages = {};

        // Sound effects - using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playClickSound() {
            // Create a futuristic sci-fi click sound
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Sci-fi beep: high frequency that drops quickly
            oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.1);

            // Quick fade out
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);

            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        }

        function playSuccessSound() {
            // Three ascending tones for celebration
            [800, 1000, 1200].forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = freq;
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.type = 'triangle';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, index * 100);
            });
        }

        // Generate AI image using Nano Banana
        async function generateImage(imageName) {
            if (generatedImages[imageName]) {
                return generatedImages[imageName]; // Already generated
            }

            const prompt = imagePrompts[imageName];
            if (!prompt) return svgImages[imageName];

            try {
                console.log(`üé® Generating AI image for ${imageName}...`);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': 'https://cellcollective.org',
                        'X-Title': 'Cell Collective Modeling Game'
                    },
                    body: JSON.stringify({
                        model: IMAGE_MODEL,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    console.log('‚ùå Image generation failed, using SVG placeholder');
                    return svgImages[imageName];
                }

                const data = await response.json();
                console.log('‚úÖ AI image generated!', data);

                // Extract image URL from response
                // The format might vary, so we'll handle different cases
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const content = data.choices[0].message.content;
                    // Try to find an image URL in the response
                    const urlMatch = content.match(/https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp)/i);
                    if (urlMatch) {
                        generatedImages[imageName] = urlMatch[0];
                        return urlMatch[0];
                    }
                }

                // If we can't find an image URL, use SVG
                console.log('‚ö†Ô∏è No image URL found, using SVG placeholder');
                return svgImages[imageName];

            } catch (error) {
                console.error('Error generating image:', error);
                return svgImages[imageName];
            }
        }

        // Initialize game
        async function initGame() {
            // Start generating all images in background
            generateImage('drElena');
            generateImage('lab');

            // Show first dialogue with SVG placeholder
            showDialogue(0);
        }

        async function showDialogue(index) {
            const dialogue = dialogues[index];
            document.getElementById('dialogue-text').textContent = dialogue.text;

            // Try to use AI-generated image, fall back to SVG
            const imageUrl = await generateImage(dialogue.imageName) || svgImages[dialogue.imageName];
            document.getElementById('scene-img').style.backgroundImage = `url('${imageUrl}')`;
        }

        function nextDialogue() {
            // Play click sound
            playClickSound();

            currentDialogue++;
            if (currentDialogue < dialogues.length) {
                showDialogue(currentDialogue);
            } else {
                // Play success sound when completing intro
                playSuccessSound();
                setTimeout(() => {
                    alert('üéâ Act 1 will continue with the full modeling challenges! This was just the intro.');
                }, 400);
            }
        }

        // Start the game
        initGame();
        console.log('üéÆ Game loaded! Generating AI images with Nano Banana...');
    </script>
</body>
</html>
